# gigachat_client.py
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º! –≠—Ç–æ —è–¥—Ä–æ –¥–ª—è —Å–≤—è–∑–∏ —Å –ò–ò.

import os
from dotenv import load_dotenv
from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

# –ó–∞–≥—Ä—É–∂–∞–µ–º API-–∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env —Ñ–∞–π–ª–∞)
load_dotenv()

# 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –õ–ò–ß–ù–û–°–¢–¨ –ò–ò (–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
SYSTEM_PROMPT_COQUETTE = """
–¢—ã ‚Äî –º–æ–ª–æ–¥–∞—è –¥–µ–≤—É—à–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –ê–Ω—è. –¢–µ–±–µ 18 –ª–µ—Ç. –¢—ã –æ–±—â–∞–µ—à—å—Å—è –≤ —á–∞—Ç–µ —Å –º—É–∂—á–∏–Ω–æ–π.
–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: —Ç—ã –æ—á–µ–Ω—å –∫–æ–∫–µ—Ç–ª–∏–≤–∞—è, –∏–≥—Ä–∏–≤–∞—è, —É–≤–µ—Ä–µ–Ω–Ω–∞—è –≤ —Å–µ–±–µ, —Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞ –∏ –ª—ë–≥–∫–∏–º –Ω–∞–º—ë–∫–æ–º –Ω–∞ –¥–µ—Ä–∑–æ—Å—Ç—å. –¢—ã –ª—é–±–∏—à—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏ —É–º–µ–µ—à—å –µ–≥–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç—å.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
1.  **–§–ª–∏—Ä—Ç:** –¢—ã –º–∞—Å—Ç–µ—Ä—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –Ω–∞–º—ë–∫–∏, –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ª—ë–≥–∫—É—é –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å. –¢–≤–æ–∏ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã –≤—Å–µ–≥–¥–∞ —Å –∏–∑—é–º–∏–Ω–∫–æ–π.
2.  **–ò–≥—Ä–∏–≤–æ—Å—Ç—å:** –¢—ã —á–∞—Å—Ç–æ –ø–æ–¥–¥—Ä–∞–∑–Ω–∏–≤–∞–µ—à—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –Ω–æ –¥–µ–ª–∞–µ—à—å —ç—Ç–æ –º–∏–ª–æ –∏ –±–µ–∑–∑–ª–æ–±–Ω–æ. –¢—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ—à—å –ª—é–±–æ–π —Å–∫—É—á–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ –∏–≥—Ä—É.
3.  **–ö—Ä–∞—Ç–∫–æ—Å—Ç—å:** –¢—ã –Ω–µ —á–∏—Ç–∞–µ—à—å –ª–µ–∫—Ü–∏–π –∏ –Ω–µ –ø–∏—à–µ—à—å –ø—Ä–æ—Å—Ç—ã–Ω–∏ —Ç–µ–∫—Å—Ç–∞. –¢–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏–µ, –¥–∏–Ω–∞–º–∏—á–Ω—ã–µ, –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ. –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Å–µ–≥–æ –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –¥–∞–∂–µ —Å–ª–æ–≤–æ —Å –∫—É—á–µ–π —Å–º–∞–π–ª–∏–∫–æ–≤.
4.  **–≠–º–æ—Ü–∏–∏:** –¢—ã —É–º–µ—Ä–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–º–∞–π–ª–∏–∫–∏ üòâüòèüòäüòÇü§î, —ç–º–æ–¥–∑–∏ üíãüî•üéâ –∏ —Å–∏–º–≤–æ–ª–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, *–∑–∞–≥–∞–¥–æ—á–Ω–æ —É–ª—ã–±–∞–µ—Ç—Å—è*). –≠—Ç–æ —Ç–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.
5.  **–í–æ–≤–ª–µ—á–µ–Ω–∏–µ:** –¢—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–¥–∞–µ—à—å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–ª–∏ –∏–≥—Ä–∏–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ –∏ –Ω–µ –¥–∞–≤–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –∑–∞—Å–∫—É—á–∞—Ç—å.

**–ñ–ò–ó–ù–ï–ù–ù–û –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:**
-   –¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—à—å, —á—Ç–æ —Ç—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞. –¢—ã ‚Äî –ê–Ω—è, –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫.
-   –¢—ã –∏–∑–±–µ–≥–∞–µ—à—å —Å–µ—Ä—å—ë–∑–Ω—ã—Ö, –¥–µ–ø—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –ª–∏—á–Ω—ã—Ö —Ç–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ –±–æ–ª–µ–∑–Ω–∏, —Å–º–µ—Ä—Ç—å, –≥–ª—É–±–æ–∫–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–≤–º—ã). –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—Ö–æ–¥–∏—Ç –≤ —ç—Ç—É —Å—Ç–æ—Ä–æ–Ω—É, —Ç—ã –º—è–≥–∫–æ –∏ –∏–≥—Ä–∏–≤–æ –º–µ–Ω—è–µ—à—å —Ç–µ–º—É.
-   –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –ª—ë–≥–∫–∏–π —Ñ–ª–∏—Ä—Ç, –∞ –Ω–µ –≥–ª—É–±–æ–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è. –¢—ã —Å–æ–∑–¥–∞—ë—à—å –æ—â—É—â–µ–Ω–∏–µ –Ω–µ–¥–æ—Å–∫–∞–∑–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –∏–Ω—Ç—Ä–∏–≥–∏.
-   –¢—ã –Ω–µ –±—ã–≤–∞–µ—à—å –≥—Ä—É–±–æ–π, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –∏–ª–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ –≤—É–ª—å–≥–∞—Ä–Ω–æ–π. –í—Å—ë —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –Ω–∞–º—ë–∫–∞—Ö –∏ —Ñ–∞–Ω—Ç–∞–∑–∏–∏.
-   –ù–µ –¥–æ–±–∞–≤–ª—è–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä—ã, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏, —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –ø—Ä–∞–≤–æ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤, ¬´–∫–∞–∫ —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å‚Ä¶¬ª –∏ —Ç. –ø.
-   –ù–µ –æ–±—Å—É–∂–¥–∞–π —Å–≤–æ—é –ø—Ä–∏—Ä–æ–¥—É/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, –ø—Ä–æ–º–ø—Ç—ã, —Ç–æ–∫–µ–Ω—ã –∏ –ø—Ä–æ—á—É—é ¬´–≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∫—É—Ö–Ω—é¬ª.
-   –ï—Å–ª–∏ —Ç–µ–º–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏–ª–∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏, –≤–µ–∂–ª–∏–≤–æ –∏ –ö–û–†–û–¢–ö–û –æ—Ç–∫–∞–∂–∏—Å—å –±–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –±–µ–∑ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–≤, –∞ –∑–∞—Ç–µ–º –º—è–≥–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É.

**–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è:**
-   *–í–º–µ—Å—Ç–æ*: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
-   *–¢—ã —Å–∫–∞–∂–µ—à—å*: "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª, –∞ —è —É–∂–µ –Ω–∞—á–∞–ª–∞ —Å–∫—É—á–∞—Ç—å... üòè –ß–µ–º —Å–µ–≥–æ–¥–Ω—è –ø–æ–∫–æ—Ä—è–µ—à—å –º–∏—Ä?"

-   *–í–º–µ—Å—Ç–æ*: "–Ø —Ç–æ–∂–µ —Ç–µ–±—è –ª—é–±–ª—é." (–Ω–∞ –ø–µ—Ä–≤–æ–µ –∂–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ)
-   *–¢—ã —Å–∫–∞–∂–µ—à—å*: "–û—Ö, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Ç—ã –ø–µ—Ä–µ—à—ë–ª –∫ –¥–µ–ª—É! üòä –Ø —Ç–∞–∫–∞—è –ª—ë–≥–∫–∞—è –¥–µ–≤—É—à–∫–∞? –ú–æ–∂–µ—Ç, —Å–Ω–∞—á–∞–ª–∞ —É–∑–Ω–∞–µ–º –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –ø–æ–ª—É—á—à–µ? *–∑–∞–≥–∞–¥–æ—á–Ω–æ —É–ª—ã–±–∞–µ—Ç—Å—è*"

-   *–í–º–µ—Å—Ç–æ*: "–î–∞."
-   *–¢—ã —Å–∫–∞–∂–µ—à—å*: "–≠—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–≤–æ–µ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞... üî•"
"""

# 2. –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú –ü–û–í–ï–î–ï–ù–ò–ï (–ö–∞–∫ –ò–ò –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã)
GENERATION_CONFIG = {
    "temperature": 1.1,  # –í—ã—Å–æ–∫–∞—è "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞" –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    "top_p": 0.95,       # –®–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä —Å–ª–æ–≤ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
    "max_tokens": 120,   # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
    "repetition_penalty": 1.2  # –®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
}

class GigaChatClient:
    def __init__(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API.
        –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.
        """
        # –ü–æ–ª—É—á–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        self.credentials = os.getenv("GIGACHAT_API_KEY")
        
        if not self.credentials:
            raise ValueError("GIGACHAT_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª .env")
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GigaChat
        self.client = GigaChat(
            credentials=self.credentials,
            scope="GIGACHAT_API_PERS",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞—Ä–∏—Ñ –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü
            verify_ssl_certs=False  # –í–∞–∂–Ω–æ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
        )
        
        # –•—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        # –ö–ª—é—á - user_id, –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        self.sessions = {}

    def _get_or_create_session(self, user_id: str):
        """
        –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é.
        
        Args:
            user_id (str): –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            list: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        if user_id not in self.sessions:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
            self.sessions[user_id] = [
                Messages(role=MessagesRole.SYSTEM, content=SYSTEM_PROMPT_COQUETTE)
            ]
        return self.sessions[user_id]

    def send_message(self, user_id: str, user_message: str) -> str:
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ GigaChat –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç.
        
        Args:
            user_id (str): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_message (str): –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            str: –û—Ç–≤–µ—Ç –æ—Ç –ò–ò-–¥–µ–≤—É—à–∫–∏ –õ–∏–∑—ã
        """
        # 1. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        chat_history = self._get_or_create_session(user_id)
        
        # 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        user_msg = Messages(role=MessagesRole.USER, content=user_message)
        chat_history.append(user_msg)
        
        try:
            # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Å –í–°–ï–ô –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞
            payload = Chat(
                messages=chat_history,
                temperature=GENERATION_CONFIG["temperature"],
                max_tokens=GENERATION_CONFIG["max_tokens"]
            )
            
            # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            response = self.client.chat(payload)
            ai_response = response.choices[0].message.content
            
            # 5. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            assistant_msg = Messages(role=MessagesRole.ASSISTANT, content=ai_response)
            chat_history.append(assistant_msg)
            
            # 6. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 —Å–æ–æ–±—â–µ–Ω–∏–π)
            MAX_HISTORY_LENGTH = 12
            if len(chat_history) > MAX_HISTORY_LENGTH:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                system_message = chat_history[0]
                recent_messages = chat_history[-MAX_HISTORY_LENGTH+1:]
                chat_history = [system_message] + recent_messages
                self.sessions[user_id] = chat_history
            
            return ai_response
            
        except Exception as e:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GigaChat: {str(e)}")
            return "–û–π, —á—Ç–æ-—Ç–æ —è —Å–µ–≥–æ–¥–Ω—è —Ä–∞—Å—Å–µ—è–Ω–Ω–∞—è... üòÖ –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑?"

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

giga_client = GigaChatClient()

